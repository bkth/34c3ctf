#include <stdio.h>
#include <stdlib.h>
#include <time.h>
#include <string.h>
#include <sys/mman.h>
#include <stdint.h>


typedef struct verif_f {
	void (*check)(char*, char*, char);
	char key;
	uint8_t index;
} verif_f;

char* code = "\x56\x52\x8a\x07\x3c\x33\x0f\x85\xdb\x02\x00\x00\xe9\xb8\x02\x00\x00\x47\x43\x9b\x16\x2d\x25\x1e\x94\xdb\x13\x11\x11\xf8\xb6\x13\x11\x11\x74\x70\xa8\x25\x1e\x61\x2d\xa7\x9b\x20\x22\x22\xcb\xb4\x20\x22\x22\x65\x61\xb9\x34\x0f\x00\x3c\xb6\x9b\x31\x33\x33\xda\xb6\x31\x33\x33\x12\x16\xce\x43\x78\x1b\x4b\xc1\xd3\x46\x44\x44\xad\x30\x46\x44\x44\x03\x07\xdf\x52\x69\x18\x5a\xd0\xd3\x57\x55\x55\xbc\x36\x57\x55\x55\x30\x34\xec\x61\x5a\x57\x69\xe3\x13\x64\x66\x66\x8f\x34\x64\x66\x66\x21\x25\xfd\x70\x4b\x30\x78\xf2\x13\x75\x77\x77\x9e\x36\x75\x77\x77\xde\xda\x02\x8f\xb4\xc0\x87\x0d\xdb\x8a\x88\x88\x61\xb8\x8a\x88\x88\xcf\xcb\x13\x9e\xa5\xcd\x96\x1c\xdb\x9b\x99\x99\x70\x86\x9b\x99\x99\xfc\xf8\x20\xad\x96\xf3\xa5\x2f\x9b\xa8\xaa\xaa\x43\xa4\xa8\xaa\xaa\xed\xe9\x31\xbc\x87\xe4\xb4\x3e\x9b\xb9\xbb\xbb\x52\x46\xba\xbb\xbb\x9a\x9e\x46\xcb\xf0\x81\xc3\x49\xc3\xce\xcc\xcc\x25\x20\xcd\xcc\xcc\x8b\x8f\x57\xda\xe1\xed\xd2\x58\x23\xdc\xdd\xdd\x34\x06\xdc\xdd\xdd\xb8\xbc\x64\xe9\xd2\xbc\xe1\x6b\x03\xef\xee\xee\x07\x24\xef\xee\xee\xa9\xad\x75\xf8\xc3\xaf\xf0\x7a\x23\xfe\xff\xff\x16\x46\xfe\xff\xff\x46\x42\x9a\x17\x2c\x78\x1f\x95\xdb\x11\x10\x10\xf9\xb8\x11\x10\x10\x77\x73\xab\x26\x1d\x10\x2e\xa4\x9b\x20\x21\x21\xc8\xb6\x20\x21\x21\x64\x60\xb8\x35\x0e\x5c\x3d\xb7\x9b\x33\x32\x32\xdb\xb4\x33\x32\x32\x15\x11\xc9\x44\x7f\x04\x4c\xc6\xdb\x42\x43\x43\xaa\x36\x42\x43\x43\x02\x06\xde\x53\x68\x0b\x5b\xd1\xd3\x55\x54\x54\xbd\x30\x55\x54\x54\x33\x37\xef\x62\x59\x02\x6a\xe0\x13\x64\x65\x65\x8c\x36\x64\x65\x65\x20\x24\xfc\x71\x4a\x46\x79\xf3\x13\x77\x76\x76\x9f\x34\x77\x76\x76\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x58\x5f\x41\xb8\x00\x00\x00\x00\x49\x83\xf8\x11\x74\x1c\x8a\x1f\x88\xc1\x30\xcb\x88\x1f\x49\xff\xc0\x48\xff\xc7\xeb\xea\xb8\x3c\x00\x00\x00\xbf\x01\x00\x00\x00\x0f\x05\xc3";


verif_f** functions;


void build_fns(char* base_addr) {

	functions = (verif_f**) malloc(sizeof(verif_f*) * 24);
	for (int i = 0; i < 23; ++i) {
		verif_f* f = (verif_f*) malloc(sizeof(verif_f));
		f->check = (void (*)(char*, char*, char)) (base_addr + 17 * i);
	       	f->key = (char) ((i * 273) % 256);
		f->index = i;	
		*(functions + i) = f;	
	}
	functions[23] = NULL;
}


void randomize_table() {
	srand(time(NULL));
	for (int i = 0; i < 256; ++i) {
		
		int a = rand() % 22 + 1;
		int b = rand() % 22 + 1;
		verif_f* tmp = functions[a];
		functions[a] = functions[b];
		functions[b] = tmp;
	}
}


int main(int argc, char *argv[]) {

	void* map = mmap(NULL, 0x1000, 7, 0x22, -1, 0);
	build_fns(map);
	memcpy(map, code, 757);
	if (argc != 2)
		exit(1);
	if (strlen(argv[1]) != 23)
		exit(1);

	randomize_table();
	for (int i = 0; i < 23; ++i) {
		verif_f* f = *(functions + i);
		verif_f* next = *(functions + i + 1);
		if (next)
			f->check(argv[1] + f->index, (char *) next->check, next->key);
	       	else
			f->check(argv[1] + f->index, (char*) map, 0);	
	}
	printf("What are you waiting for, go submit that flag!\n");
}
